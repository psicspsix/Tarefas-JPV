<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Tarefas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 {
            text-align: center;
            color: #ffffff;
        }
        input, button {
            font-size: 18px;
            padding: 10px;
            margin: 5px;
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        #taskInput {
            width: 600px;
        }
        button:hover {
            background: #555;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            font-size: 18px;
            margin: 10px 0;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .completed {
            text-decoration: line-through;
            color: #888;
        }
        #error {
            color: #ff5555;
            text-align: center;
        }
        #success {
            color: #55ff55;
            text-align: center;
        }
        .notes {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #333;
            border-radius: 5px;
        }
        .notes.visible {
            display: block;
        }
        textarea {
            width: 100%;
            background: #444;
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 5px;
        }
        .has-notes {
            margin-left: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Minhas Tarefas</h1>
    <input type="text" id="taskInput" placeholder="Digite uma tarefa">
    <input type="date" id="dueDate" placeholder="Data de término (opcional)">
    <input type="number" id="priority" min="1" max="1000" placeholder="Prioridade (1-1000)">
    <button id="actionButton">Adicionar</button>
    <div id="error"></div>
    <div id="success"></div>
    <ul id="taskList"></ul>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBiFPswIXLxgaHwxXlDX0ov4d0WYa6xJvk",
            authDomain: "tarefas-jpv.firebaseapp.com",
            projectId: "tarefas-jpv",
            storageBucket: "tarefas-jpv.firebasestorage.app",
            messagingSenderId: "641273600681",
            appId: "1:641273600681:web:2873afa0828d9332a9e7b8",
            measurementId: "G-X3ZS96CKF2",
            databaseURL: "https://tarefas-jpv-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tasksRef = ref(db, 'tasks');
        let editingTaskKey = null;

        console.log("Firebase conectado com sucesso!");

        // Função para salvar ou atualizar tarefa
        function saveTask() {
            const taskInput = document.getElementById('taskInput');
            const dueDateInput = document.getElementById('dueDate');
            const priorityInput = document.getElementById('priority');
            const taskText = taskInput.value.trim();
            let dueDate = dueDateInput.value || null;
            const priority = parseInt(priorityInput.value) || 1;

            if (taskText === '') {
                document.getElementById('error').textContent = "Preencha a tarefa!";
                return;
            }

            if (editingTaskKey) {
                const taskRef = ref(db, `tasks/${editingTaskKey}`);
                onValue(taskRef, (snapshot) => {
                    const currentTask = snapshot.val();
                    set(taskRef, {
                        text: taskText,
                        dueDate: dueDate,
                        priority: Math.min(Math.max(priority, 1), 1000),
                        notes: currentTask.notes || "",
                        completed: currentTask.completed || false
                    }).then(() => {
                        resetForm();
                        document.getElementById('success').textContent = "Tarefa atualizada com sucesso!";
                        setTimeout(() => document.getElementById('success').textContent = '', 2000);
                    }).catch((error) => {
                        document.getElementById('error').textContent = "Erro ao atualizar: " + error.message;
                    });
                }, { onlyOnce: true });
            } else {
                push(tasksRef, {
                    text: taskText,
                    dueDate: dueDate,
                    priority: Math.min(Math.max(priority, 1), 1000),
                    notes: "",
                    completed: false
                }).then(() => {
                    resetForm();
                    document.getElementById('success').textContent = "Tarefa adicionada com sucesso!";
                    setTimeout(() => document.getElementById('success').textContent = '', 2000);
                }).catch((error) => {
                    document.getElementById('error').textContent = "Erro ao adicionar: " + error.message;
                });
            }
        }

        // Função para resetar o formulário
        function resetForm() {
            document.getElementById('taskInput').value = '';
            document.getElementById('dueDate').value = '';
            document.getElementById('priority').value = '';
            document.getElementById('actionButton').textContent = 'Adicionar';
            document.getElementById('error').textContent = '';
            editingTaskKey = null;
        }

        // Função para editar tarefa
        function editTask(key) {
            const taskRef = ref(db, `tasks/${key}`);
            onValue(taskRef, (snapshot) => {
                const task = snapshot.val();
                document.getElementById('taskInput').value = task.text;
                document.getElementById('dueDate').value = task.dueDate || '';
                document.getElementById('priority').value = task.priority;
                document.getElementById('actionButton').textContent = 'Salvar';
                editingTaskKey = key;
            }, { onlyOnce: true });
        }

        // Funções auxiliares
        function toggleTask(key) {
            const taskRef = ref(db, `tasks/${key}`);
            onValue(taskRef, (snapshot) => {
                const task = snapshot.val();
                update(taskRef, { completed: !task.completed });
            }, { onlyOnce: true });
        }

        function deleteTask(key) {
            const taskRef = ref(db, `tasks/${key}`);
            remove(taskRef);
        }

        function toggleNotes(li) {
            const notesDiv = li.querySelector('.notes');
            notesDiv.classList.toggle('visible');
        }

        function updateNotes(key, textarea) {
            const taskRef = ref(db, `tasks/${key}`);
            update(taskRef, { notes: textarea.value });
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Sem data';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // Renderiza as tarefas
        onValue(tasksRef, (snapshot) => {
            const tasks = snapshot.val() || {};
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = tasks ? '' : '<li>Sem tarefas ainda.</li>';
            const taskArray = Object.entries(tasks).sort((a, b) => {
                if (a[1].completed !== b[1].completed) {
                    return a[1].completed - b[1].completed;
                }
                const dateA = a[1].dueDate || '9999-12-31';
                const dateB = b[1].dueDate || '9999-12-31';
                if (dateA !== dateB) {
                    return dateA.localeCompare(dateB);
                }
                return b[1].priority - a[1].priority;
            });
            taskArray.forEach(([key, task]) => {
                const li = document.createElement('li');
                li.className = task.completed ? 'completed' : '';
                li.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''}>
                    <span>${task.text} | Data: ${formatDate(task.dueDate)} | Prioridade: ${task.priority}</span>
                    <button class="edit-btn">Editar</button>
                    <button class="delete-btn">Excluir</button>
                    ${task.notes && task.notes.trim() !== '' ? '<span class="has-notes">Contém Nota</span>' : ''}
                    <div class="notes">
                        <textarea rows="3">${task.notes || ''}</textarea>
                    </div>
                `;
                li.querySelector('input[type="checkbox"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTask(key);
                });
                li.querySelector('span').addEventListener('click', () => toggleNotes(li));
                li.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editTask(key);
                });
                li.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTask(key);
                });
                li.querySelector('textarea').addEventListener('change', (e) => updateNotes(key, e.target));
                li.querySelector('textarea').addEventListener('click', (e) => e.stopPropagation());
                taskList.appendChild(li);
            });
        }, (error) => {
            document.getElementById('error').textContent = "Erro ao carregar tarefas: " + error.message;
        });

        // Vincula o evento ao botão de ação
        document.getElementById('actionButton').addEventListener('click', saveTask);

    </script>
</body>
</html>
